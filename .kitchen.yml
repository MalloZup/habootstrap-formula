---
driver:
  name: docker
  use_sudo: false
  privileged: true
  require_chef_omnibus: false
  run_command: /usr/lib/systemd/systemd
  cap_add:
    - SYS_ADMIN
  volume:
    - /sys/fs/cgroup    

verifier:
  name: inspec
  inspec_tests:
    - test/integration/cluster/inspec

platforms:
  - name: opensuse
    driver_config:
      image: opensuse/leap:15
      platform: opensuse
      run_command: /usr/lib/systemd/systemd
      provision_command:
        - "(cd /usr/lib/systemd/system/sysinit.target.wants/; for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done); rm -f /usr/lib/systemd/system/multi-user.target.wants/*; rm -f /etc/systemd/system/*.wants/*; rm -f /usr/lib/systemd/system/local-fs.target.wants/*; rm -f /usr/lib/systemd/system/sockets.target.wants/*udev*; rm -f /usr/lib/systemd/system/sockets.target.wants/*initctl*; rm -f /usr/lib/systemd/system/basic.target.wants/*; rm -f /usr/lib/systemd/system/anaconda.target.wants/*;"
        - sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
        - systemctl enable sshd
        - zypper -n --gpg-auto-import-keys in crmsh resource-agents fence-agents salt
provisioner:
  name: salt_solo
  require_chef: false
  formula: cluster
  salt_install: distrib
  state_top:
    base:
      '*':
        - cluster
  pillars-from-files:
    base.sls: pillar.example
  pillars:
    top.sls:
      base:
        '*':
          - base
          - cluster

suites:
  - name: cluster-init
    provisioner:
      pillars:
        cluster.sls:
          cluster:
            mode: init
